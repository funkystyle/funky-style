angular.module("storeinfoModule",["Directives","satellizer"]).controller("storeinfoController",["$scope","$stateParams","$http","$state","$auth","$filter","$sce","$ocLazyLoad","$rootScope","$compile","StoreQuery","$q",function(e,t,o,n,r,s,a,i,u,c,f,p){if(e.favorites={},e.comment={},e.filter={category:{},wallet:{},bank:{},city:{},brands:{},festivals:{}},e.search={category:void 0,wallet:void 0,bank:void 0,city:void 0,brands:void 0,festivals:void 0},e.showMore={all:{},deals:{},coupons:{}},e.store={},e.coupons=[],e.expiredCoupons=[],e.suggestedCoupons=[],e.relatedCoupons=[],e.filterCoupons=[],e.categories={},e.trustAsHtml=function(e){if(e)return a.trustAsHtml(e)},e.showDescription=function(e){$(".show-description").hide(),$("#show-desc-"+e).fadeIn(200)},e.closeDescription=function(){$(".show-description").fadeOut()},e.manageFavorite=function(t,o){var n=!e.favorites[o];if(!r.isAuthenticated())return!0;var s={url:"/api/1.0/persons/"+e.user._id,method:"PATCH",data:{}},a=e.user[t].indexOf(o);n?-1==a&&e.user[t].push(o):e.user[t].splice(a,1),s.data[t]=e.user[t],f.postFav(s).then(function(t){e.favorites[o]=n},function(e){})},e.applyFilter=function(){e.filterCoupons=s("couponFilter")(e.coupons,e.filter),e.dealsLength=s("filter")(e.filterCoupons,{coupon_type:"offer"}),e.couponsLength=s("filter")(e.filterCoupons,{coupon_type:"coupon"})},e.openCouponCode=function(e,t){var o="/api/1.0/coupons/"+t._id+"?number_of_clicks=1";f.get(o),e.store_url&&setTimeout(function(){},500),o=n.href("main.store-info",{url:e.url,cc:t._id}),window.open(o,"_blank")},$("#top_banner_area").hide(),t.url){var l={};l.recommended_stores=1,l.related_categories=1,l.top_stores=1,l.related_stores=1,l.related_deals=1;var d="/api/1.0/stores/"+t.url+"?embedded="+JSON.stringify(l)+"&number_of_clicks=1";f.get(d).then(function(t){if(t.data){t.data||n.go("404"),e.store=t.data,e.store.related_stores=clearNullIds(e.store.related_stores),e.store.top_stores=clearNullIds(e.store.top_stores),e.store.related_deals=clearNullIds(e.store.related_deals),e.store.toDayDate=new Date,e.store.voting=Math.floor(201*Math.random())+300,u.pageTitle=e.store.meta_title,$("title").text(e.store.meta_title),u.pageDescription=e.store.meta_description,e.favorites[e.store._id]=!1,angular.forEach(e.user.fav_stores,function(t){t==e.store._id&&(e.favorites[e.store._id]=!0)}),l={related_categories:1,related_stores:1},l=JSON.stringify(l);var o={};if(o.recommended_stores={$in:[e.store._id]},r="/api/1.0/coupons?where="+JSON.stringify(o)+"&embedded="+l,f.get(r).then(function(t){e.suggestedCoupons=t.data._items}),o={related_stores:{$in:[e.store._id]}},r="/api/1.0/coupons?where="+JSON.stringify(o)+"&embedded="+l,f.get(r).then(function(t){var n=t.data._items,a=[];angular.forEach(n,function(t){if(angular.forEach(e.user.fav_coupons,function(o){o==t._id&&(e.favorites[t._id]=!0)}),angular.forEach(t.related_categories,function(t){if(null==t)return!0;e.categories[t.category_type]?s("filter")(e.categories[t.category_type],{_id:t._id}).length||e.categories[t.category_type].push(t):(e.categories[t.category_type]=[],e.categories[t.category_type].push(t))}),new Date(t.expire_date)>new Date){if(t._updated=new Date(t._updated),-1==e.coupons.indexOf(t)){e.coupons.push(t),e.filterCoupons.push(t),e.dealsLength=s("filter")(e.filterCoupons,{coupon_type:"offer"}),e.couponsLength=s("filter")(e.filterCoupons,{coupon_type:"coupon"});var n=JSON.stringify({user:1});o=JSON.stringify({coupon:t._id,status:!0}),r="/api/1.0/coupons_comments?embedded="+n+"&where="+o,a.push(f.get(r).then(function(e){return e}))}}else-1==e.expiredCoupons.indexOf(t)&&e.expiredCoupons.push(t)}),p.all(a).then(function(t){var o=[];angular.forEach(t,function(e){angular.forEach(e.data._items,function(e){o.push(e)})}),angular.forEach(e.coupons,function(e){e.comments=[],angular.forEach(o,function(t){t._created=new Date(t._created),t.coupon==e._id&&e.comments.push(t)})}),e.filterComments=angular.copy(e.coupons)})}),angular.forEach(e.store.related_stores,function(t){o=JSON.stringify(o={related_stores:{$in:[t._id]}});r="/api/1.0/coupons?where="+o+"&max_results=1&sort=[('_updated', -1)]&embedded="+l,f.get(r).then(function(t){var o=t.data._items;angular.forEach(o,function(t){s("filter")(e.relatedCoupons,{_id:t._id}).length||e.relatedCoupons.push(t)})})}),0==e.store.top_stores.length){f.get('/api/1.0/stores?where={"featured_store": true}&max_results=2').then(function(t){t.data._items&&(e.store.top_stores=t.data._items,angular.forEach(e.store.related_stores,function(t){angular.forEach(e.store.top_stores,function(o,n){o._id==t._id&&e.store.top_stores.splice(n,1)})}))},function(e){})}}e.top_banner={};var r="/api/1.0/banner?where="+JSON.stringify({top_banner_string:"store"});f.get(r).then(function(t){e.top_banner=t.data._items[0],$("#top_banner_area").show()})},function(e){})}else n.go("main.home");e.openComment=function(t){if($("comments").remove(),r.isAuthenticated()){e.info={item:t,token:r.getToken()};var o=c("<comments info='info'></comments>")(e);$("body").append(o),setTimeout(function(){$("#commentPopup").modal("show")},1e3)}else n.go("main.login")},e.openReport=function(t){if($("reports").remove(),r.isAuthenticated()){e.info={item:t,token:r.getToken()};var o=c("<reports info='info'></reports>")(e);$("body").append(o),setTimeout(function(){$("#reportPopup").modal("show")},1e3)}else n.go("main.login")},t.cc&&($("coupon-info-popup").remove(),e.$watch("coupons",function(o,n){o&&angular.forEach(o,function(o){if(o._id==t.cc){e.couponInfo=o;var n=c("<coupon-info-popup parent='store' type='store' coupon='couponInfo'></coupon-info-popup>")(e);$("body").append(n),setTimeout(function(){$("#couponPopup").modal("show")},1e3)}})},!0))}]).filter("couponFilter",function(){return function(e,t){var o=[];if(!(Object.keys(t.category).length||Object.keys(t.wallet).length||Object.keys(t.bank).length||Object.keys(t.city).length||Object.keys(t.brands).length||Object.keys(t.festivals).length))return e;var n=0;return angular.forEach(t,function(e,t){angular.forEach(e,function(e,t){1==e&&n++})}),0==n?e:(angular.forEach(e,function(e){angular.forEach(e.related_categories,function(n){angular.forEach(t,function(t,r){angular.forEach(t,function(t,r){n&&1==t&&r==n._id&&-1==o.indexOf(e)&&o.push(e)})})})}),o)}}).factory("StoreQuery",["$http","$q",function(e,t){return{postFav:function(o){var n=t.defer();return e(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},get:function(o){var n=t.defer();return e({url:o+"&r="+Math.random(),method:"GET"}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}}]);