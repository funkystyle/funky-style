angular.module("dealDetailsModule",["Directives"]).controller("dealDetailsCtrl",["$scope","$ocLazyLoad","$http","$state","$stateParams","$sce","Query",function(e,t,a,n,o,r,i){console.log("deal Details controller!"),e.deal={},e.showMore={},e.imageShow={},e.trustAsHtml=function(e){if(e)return r.trustAsHtml(e)},e.goScroll=function(e){console.log($("#"+e).position().top+150),$("html, body").animate({scrollTop:$("#"+e).offset().top-150})};var s=(new Date).getDate(),l=JSON.stringify({featured:!0});a({url:"/api/1.0/deal_brands?where="+l+"&max_results=8&rand="+s,method:"GET"}).then(function(t){console.log("Deal Brands are: ",t.data._items),e.deal_brands=t.data._items},function(e){console.log(e)}),e.top_banner={};var d=JSON.stringify({top_banner_string:"deal_individual"}),u="/api/1.0/banner?where="+d;i.get(u).then(function(t){console.log("banner Details: ",t.data._items),e.top_banner=t.data._items[0]}),e.side_banner={};u="/api/1.0/banner?where="+(d=JSON.stringify({side_banner_string:"deal_individual"}));if(i.get(u).then(function(t){console.log("banner Details: ",t.data._items),e.side_banner=t.data._items[0]}),o.url){u="/api/1.0/deals?where="+(d=JSON.stringify({url:o.url}))+"&number_of_clicks=1&embedded="+JSON.stringify({related_deals:1,deal_brands:1,deal_category:1,stores:1,"stores.store":1,store_temp:1})+"&rand_number"+Math.random();a({url:u,method:"GET"}).then(function(t){if(console.log(t),t.data&&t.data._items.length){if(console.log(t.data._items[0]),e.deal=t.data._items[0],e.deal.toDayDate=new Date,e.deal.voting=Math.floor(201*Math.random())+300,e.deal.expired_date=new Date(e.deal.expired_date),"store"==e.deal.deal_type){var o={};o.related_stores={$in:[e.deal.store_temp._id]};u="/api/1.0/coupons?where="+JSON.stringify(o)+"&max_results=5&sort=[('_updated', -1)]",a({url:u,method:"GET"}).then(function(t){console.log("Coupons List: ",t),e.store_related_coupons=t.data._items})}}else n.go("404")},function(e){console.log(e)}),e.top_stores=[];var c={name:1,url:1,image:1};a({url:"/api/1.0/stores?projection="+JSON.stringify(c)+"&rand_number"+(new Date).getTime(),method:"GET"}).then(function(t){t.data&&(e.top_stores=t.data._items)},function(e){console.log(e)})}}]).filter("quickLimit",function(){return function(e){var t={};return angular.forEach(e,function(e,a){Object.keys(t).length<15&&(t[a]=e)}),t}}).factory("Query",["$http","$q",function(e,t){return{get:function(a){var n=t.defer();return e({url:a+"&r="+Math.random(),method:"GET"}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}}]);