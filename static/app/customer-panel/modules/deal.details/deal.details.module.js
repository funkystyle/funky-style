angular.module("dealDetailsModule",["Directives","toastr"]).controller("dealDetailsCtrl",["$scope","toastr","$ocLazyLoad","$http","$compile","$state","$stateParams","$sce","Query","DestionationUrl",function(e,t,n,o,a,r,i,d,s,u){e.deal={},e.showMore={},e.imageShow={},e.trustAsHtml=function(e){if(e)return d.trustAsHtml(e)},e.goScroll=function(e){var t=$("#"+e);$("html, body").animate({scrollTop:t.offset().top-150})};var l=(new Date).getDate(),c=JSON.stringify({featured:!0});o({url:"/api/1.0/deal_brands?where="+c+"&max_results=8&rand="+l,method:"GET"}).then(function(t){e.deal_brands=t.data._items},function(e){}),e.top_banner={};var p=JSON.stringify({top_banner_string:"deal_individual",expired_date:{$gte:(new Date).toGMTString()}}),f="/api/1.0/banner?where="+p;if(s.get(f).then(function(t){e.top_banner=t.data._items[0]}),e.side_banner={},p=JSON.stringify({side_banner_string:"deal_individual"}),f="/api/1.0/banner?where="+p,s.get(f).then(function(t){e.side_banner=t.data._items[0]}),i.url){p=JSON.stringify({url:i.url});var _=JSON.stringify({related_deals:1,deal_brands:1,deal_category:1,stores:1,"stores.store":1,store_temp:1});f="/api/1.0/deals?where="+p+"&number_of_clicks=1&embedded="+_+"&rand_number"+Math.random(),o({url:f,method:"GET"}).then(function(t){if(t.data&&t.data._items.length){if(e.deal=t.data._items[0],e.deal.toDayDate=new Date,e.deal.voting=Math.floor(201*Math.random())+300,e.deal.expired_date=new Date(e.deal.expired_date),"store"===e.deal.deal_type){var n={};n.related_stores={$in:[e.deal.store_temp._id]},n.status="Publish";f="/api/1.0/coupons?where="+JSON.stringify(n)+"&max_results=5&sort=[('_updated', -1)]",o({url:f,method:"GET"}).then(function(t){e.store_related_coupons=t.data._items})}}else r.go("404")},function(e){}),e.top_stores=[];var m={name:1,url:1,image:1};o({url:"/api/1.0/stores?projection="+JSON.stringify(m)+"&rand_number"+(new Date).getTime(),method:"GET"}).then(function(t){t.data&&(e.top_stores=t.data._items)},function(e){})}e.openCouponCode=function(e,n){u.destination_url(n.destination_url).then(function(e){var o=e.data.data.output_url,a=o||n.destination_url,d=r.go("main.deal_post_details",{url:i.url,cc:n._id,destionationUrl:a}),s=window.open(d,"newtab");null===s||void 0===s?t.error("Please disable your pop-up blocker and click the link again to copy your Coupon Code","Disable Pop-Up Blocker!"):(s.focus(),window.location.href=a)},function(e){})},e.goDeeplink=function(t){var n={destination_url:t};e.openCouponCode({},n)},i.cc&&($("coupon-info-popup").remove(),_=JSON.stringify({related_stores:1,related_categories:1}),f="/api/1.0/coupons/"+i.cc+"?number_of_clicks=1&embedded="+_+"&rand="+Math.random(),o.get(f).then(function(t){e.couponInfo=t.data;var n=a("<coupon-info-popup parent='store' type='store' coupon='couponInfo'></coupon-info-popup>")(e);$("body").append(n),setTimeout(function(){$("#couponPopup").modal("show")},1e3)},function(e){r.go("main.deal_post_details",{url:i.url,cc:void 0,destionationUrl:void 0})}))}]).filter("quickLimit",function(){return function(e){var t={};return angular.forEach(e,function(e,n){Object.keys(t).length<15&&(t[n]=e)}),t}}).factory("Query",["$http","$q",function(e,t){return{get:function(n){var o=t.defer();return e({url:n+"&r="+Math.random(),method:"GET"}).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}}]);