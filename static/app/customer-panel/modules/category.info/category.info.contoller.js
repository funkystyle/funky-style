angular.module("categoryinfoModule",["Directives","satellizer"]).controller("categoryinfoCtrl",["$scope","$state","$filter","$ocLazyLoad","$sce","Query","$q","$stateParams","$http","$rootScope","$compile","$auth","DestionationUrl",function(e,o,t,n,r,a,i,c,u,s,l,p,f){if(e.favorites={},e.filter={store:{},wallet:{}},e.showMore={all:{},deals:{},coupons:{}},e.params=void 0,e.search={store:void 0,wallet:void 0},e.category=void 0,e.coupons=[],e.filterCoupons=[],e.expiredCoupons=[],e.categories={},e.stores=[],e.manageFavorite=function(o,t){var n=!e.favorites[t];if(!p.isAuthenticated())return!0;var r={url:"/api/1.0/persons/"+e.user._id,method:"PATCH",data:{}},a=e.user[o].indexOf(t);n?-1==a&&e.user[o].push(t):e.user[o].splice(a,1),r.data[o]=e.user[o],StoreQuery.postFav(r).then(function(o){e.favorites[t]=n},function(e){})},e.trustAsHtml=function(e){return r.trustAsHtml(e)},e.applyFilter=function(){e.filterCoupons=t("couponFilter")(e.coupons,e.filter),e.dealsLength=t("filter")(e.filterCoupons,{coupon_type:"offer"}),e.couponsLength=t("filter")(e.filterCoupons,{coupon_type:"coupon"})},e.openCouponCode=function(t,n){var r="/api/1.0/coupons/"+n._id+"?number_of_clicks=1";a.get(r),f.destination_url(n.destination_url).then(function(a){e.destionationUrl=a.data.data.output_url,r=o.href("main.categoryinfo",{url:t.url,cc:n._id,destionationUrl:e.destionationUrl}),window.open(r,"_blank"),window.location.href=e.destionationUrl},function(e){})},c.url){var d={};d.url=c.url;var g={};g.related_categories=1,g.top_stores=1,g.related_coupons=1,g["related_coupons.related_categories"]=1,g["related_coupons.related_stores"]=1,url="/api/1.0/categories/?where="+JSON.stringify(d)+"&embedded="+JSON.stringify(g)+"&r="+Math.random(),u({url:url,method:"GET"}).then(function(n){if(n.data)if(n.data._items.length){e.category=n.data._items[0],e.category.toDayDate=new Date,e.category.voting=Math.floor(201*Math.random())+300,e.category.top_stores=clearNullIds(e.category.top_stores),e.category.related_categories=clearNullIds(e.category.related_categories),e.category.top_categories=clearNullIds(e.category.top_categories),e.category.related_deals=clearNullIds(e.category.related_deals),e.category.related_coupons=clearNullIds(e.category.related_coupons),s.pageTitle=e.category.seo_title,s.pageDescription=e.category.seo_description;var r=[];angular.forEach(e.category.related_coupons,function(o){if(o._updated=new Date(o._updated),angular.forEach(e.user.fav_coupons,function(t){t==o._id&&(e.favorites[o._id]=!0)}),new Date(o.expire_date)>new Date&&-1==e.coupons.indexOf(o)){e.coupons.push(o),e.filterCoupons.push(o),e.dealsLength=t("filter")(e.filterCoupons,{coupon_type:"offer"}),e.couponsLength=t("filter")(e.filterCoupons,{coupon_type:"coupon"});var n=JSON.stringify({user:1});temp=JSON.stringify({coupon:o._id,status:!0}),c="/api/1.0/coupons_comments?embedded="+n+"&where="+temp,r.push(a.get(c).then(function(e){return e}))}}),i.all(r).then(function(o){var t=[];angular.forEach(o,function(e){angular.forEach(e.data._items,function(e){t.push(e)})}),angular.forEach(e.coupons,function(e){e.comments=[],angular.forEach(t,function(o){o._created=new Date(o._created),o.coupon==e._id&&e.comments.push(o)})}),e.filterComments=angular.copy(e.coupons)}),angular.forEach(e.coupons,function(o){angular.forEach(o.related_categories,function(o){if(null==o)return!0;e.categories[o.category_type]?t("filter")(e.categories[o.category_type],{_id:o._id}).length||e.categories[o.category_type].push(o):(e.categories[o.category_type]=[],e.categories[o.category_type].push(o))}),angular.forEach(o.related_stores,function(o){t("filter")(e.stores,{_id:o._id}).length||e.stores.push(o)})})}else o.go("404");e.top_banner={};var c="/api/1.0/banner?where="+JSON.stringify({top_banner_string:"category"});a.get(c).then(function(o){e.top_banner=o.data._items[0]})},function(e){})}else o.go("main.category");e.openComment=function(o){if($("comments").remove(),p.isAuthenticated()){e.info={item:o,token:p.getToken()};var t=l("<comments info='info'></comments>")(e);$("body").append(t),setTimeout(function(){$("#commentPopup").modal("show")},1e3)}},e.openReport=function(t){if($("reports").remove(),p.isAuthenticated()){e.info={item:t,token:p.getToken()};var n=l("<reports info='info'></reports>")(e);$("body").append(n),setTimeout(function(){$("#reportPopup").modal("show")},1e3)}else o.go("main.login")},c.cc&&($("coupon-info-popup").remove(),e.$watch("coupons",function(o,t){o&&angular.forEach(o,function(o){if(o._id==c.cc){e.couponInfo=o;var t=l("<coupon-info-popup parent='category' type='category' coupon='couponInfo'></coupon-info-popup>")(e);$("body").append(t),setTimeout(function(){$("#couponPopup").modal("show")},1e3)}})},!0))}]).filter("couponFilter",function(){return function(e,o){var t=[];if(!Object.keys(o.store).length&&!Object.keys(o.wallet).length)return e;var n=0;return angular.forEach(o,function(e,o){angular.forEach(e,function(e,o){1==e&&n++})}),0==n?e:(angular.forEach(e,function(e){angular.forEach(o,function(o,n){angular.forEach(o,function(o,n){angular.forEach(e.related_stores,function(r){r&&1==o&&n==r._id&&-1==t.indexOf(e)&&t.push(e)}),angular.forEach(e.related_categories,function(r){r&&1==o&&n==r._id&&-1==t.indexOf(e)&&t.push(e)})})})}),t)}}).factory("Query",["$http","$q",function(e,o){return{get:function(t){var n=o.defer();return e({url:t+"&r="+Math.random(),method:"GET"}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}}]);