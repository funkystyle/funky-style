angular.module("categoryinfoModule",["categoryFactoryModule","storeServiceModule","couponFactoryModule","Directives","satellizer"]).controller("categoryinfoCtrl",["$scope","$state","$filter","$ocLazyLoad","$sce","Query","$q","$stateParams","$http","$rootScope","$compile","$auth",function(o,e,t,n,r,a,c,s,i,u,l,p){if(o.favorites={},o.filter={store:{},wallet:{}},o.showMore={all:{},deals:{},coupons:{}},o.params=void 0,o.search={store:void 0,wallet:void 0},o.category=void 0,o.coupons=[],o.filterCoupons=[],o.expiredCoupons=[],o.categories={},o.stores=[],o.manageFavorite=function(e,t){var n=!o.favorites[t];if(!p.isAuthenticated())return!0;console.log(e,o.user[e],t);var r={url:"/api/1.0/persons/"+o.user._id,method:"PATCH",data:{}},a=o.user[e].indexOf(t);n?-1==a&&o.user[e].push(t):o.user[e].splice(a,1),r.data[e]=o.user[e],StoreQuery.postFav(r).then(function(e){console.log("Success Store Favorite: ",e),o.favorites[t]=n},function(o){console.log(o)})},o.trustAsHtml=function(o){return r.trustAsHtml(o)},o.applyFilter=function(){o.filterCoupons=t("couponFilter")(o.coupons,o.filter),o.dealsLength=t("filter")(o.filterCoupons,{coupon_type:"offer"}),o.couponsLength=t("filter")(o.filterCoupons,{coupon_type:"coupon"})},o.openCouponCode=function(o,t){var n="/api/1.0/coupons/"+t._id+"?number_of_clicks=1";a.get(n),n=e.href("main.categoryinfo",{url:o.url,cc:t._id}),window.open(n,"_blank")},s.url){var f={};f.url=s.url;var g={};g.related_categories=1,g.top_stores=1,g.related_coupons=1,g["related_coupons.related_categories"]=1,g["related_coupons.related_stores"]=1,url="/api/1.0/categories/?where="+JSON.stringify(f)+"&embedded="+JSON.stringify(g)+"&r="+Math.random(),i({url:url,method:"GET"}).then(function(n){if(console.log(n),n.data)if(n.data._items.length){o.category=n.data._items[0],o.category.toDayDate=new Date,o.category.voting=Math.floor(201*Math.random())+300,o.category.top_stores=clearNullIds(o.category.top_stores),o.category.related_categories=clearNullIds(o.category.related_categories),o.category.top_categories=clearNullIds(o.category.top_categories),o.category.related_deals=clearNullIds(o.category.related_deals),o.category.related_coupons=clearNullIds(o.category.related_coupons),u.pageTitle=o.category.seo_title,u.pageDescription=o.category.seo_description,console.log("Final Category details: ",o.category);var r=[];angular.forEach(o.category.related_coupons,function(e){if(e._updated=new Date(e._updated),console.log(o.user,o.user.fav_coupons),angular.forEach(o.user.fav_coupons,function(t){t==e._id&&(o.favorites[e._id]=!0)}),new Date(e.expire_date)>new Date&&-1==o.coupons.indexOf(e)){o.coupons.push(e),o.filterCoupons.push(e),o.dealsLength=t("filter")(o.filterCoupons,{coupon_type:"offer"}),o.couponsLength=t("filter")(o.filterCoupons,{coupon_type:"coupon"});var n=JSON.stringify({user:1});temp=JSON.stringify({coupon:e._id,status:!0}),s="/api/1.0/coupons_comments?embedded="+n+"&where="+temp,r.push(a.get(s).then(function(o){return console.log(o.data._items),o}))}}),c.all(r).then(function(e){console.log("Comments Are: ",e,"Coupons: ",o.coupons);var t=[];angular.forEach(e,function(o){angular.forEach(o.data._items,function(o){t.push(o)})}),angular.forEach(o.coupons,function(o){o.comments=[],angular.forEach(t,function(e){e._created=new Date(e._created),e.coupon==o._id&&o.comments.push(e)})}),o.filterComments=angular.copy(o.coupons)}),angular.forEach(o.coupons,function(e){angular.forEach(e.related_categories,function(e){if(null==e)return!0;o.categories[e.category_type]?t("filter")(o.categories[e.category_type],{_id:e._id}).length||o.categories[e.category_type].push(e):(o.categories[e.category_type]=[],o.categories[e.category_type].push(e))}),angular.forEach(e.related_stores,function(e){t("filter")(o.stores,{_id:e._id}).length||o.stores.push(e)})}),console.log(o.stores,o.coupons,"categories",o.categories)}else e.go("404");o.top_banner={};var s="/api/1.0/banner?where="+JSON.stringify({top_banner_string:"category"});a.get(s).then(function(e){console.log("banner Details: ",e.data._items),o.top_banner=e.data._items[0]})},function(o){console.log(o)})}else e.go("main.category");o.openComment=function(e){if(console.log("Comment Coupon Item: ",e),$("comments").remove(),p.isAuthenticated()){o.info={item:e,token:p.getToken()};var t=l("<comments info='info'></comments>")(o);$("body").append(t),setTimeout(function(){$("#commentPopup").modal("show")},1e3),console.log(t)}},o.openReport=function(t){if(console.log("Report Coupon Item: ",t),$("reports").remove(),p.isAuthenticated()){o.info={item:t,token:p.getToken()};var n=l("<reports info='info'></reports>")(o);$("body").append(n),setTimeout(function(){$("#reportPopup").modal("show")},1e3),console.log(n)}else e.go("main.login")},s.cc&&($("coupon-info-popup").remove(),o.$watch("coupons",function(e,t){console.log(e,t),e&&angular.forEach(e,function(e){if(e._id==s.cc){o.couponInfo=e;var t=l("<coupon-info-popup parent='category' type='category' coupon='couponInfo'></coupon-info-popup>")(o);$("body").append(t),setTimeout(function(){$("#couponPopup").modal("show")},1e3),console.log(t)}})},!0))}]).filter("couponFilter",function(){return function(o,e){var t=[];if(!Object.keys(e.store).length&&!Object.keys(e.wallet).length)return o;var n=0;return angular.forEach(e,function(o,e){angular.forEach(o,function(o,e){1==o&&n++})}),0==n?o:(angular.forEach(o,function(o){angular.forEach(e,function(e,n){angular.forEach(e,function(e,n){angular.forEach(o.related_stores,function(r){r&&1==e&&n==r._id&&-1==t.indexOf(o)&&t.push(o)}),angular.forEach(o.related_categories,function(r){console.log("Related Category: ",r),r&&1==e&&n==r._id&&-1==t.indexOf(o)&&t.push(o)})})})}),t)}}).factory("Query",["$http","$q",function(o,e){return{get:function(t){var n=e.defer();return o({url:t+"&r="+Math.random(),method:"GET"}).then(function(o){n.resolve(o)},function(o){n.reject(o)}),n.promise}}}]);