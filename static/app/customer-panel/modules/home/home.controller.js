angular.module("homeModule",["headerModule","Directives"]).controller("homeCtrl",["$scope","$sce","$http","$filter","$ocLazyLoad","$state","$stateParams","$rootScope","SEO","$compile","Query","DestionationUrl",function(o,e,t,n,r,i,a,s,c,u,l,d){o.params=void 0,o.deals=[],o.categories=[];var p={};p.related_categories=1,p.related_stores=1,o.fillCoupons=function(e){o.coupons=[],l.get(e).then(function(e){if(console.log(e),e.data){var t=e.data._items;angular.forEach(t,function(e){new Date(e.expire_date)>new Date&&-1===o.coupons.indexOf(e)&&o.coupons.push(e)})}},function(o){console.log(o)})},o.featuredResults=function(){var e="/api/1.0/coupons?where="+JSON.stringify({featured_coupon:!0})+"&max_results=10&sort=-_created&embedded="+JSON.stringify(p)+"&rand="+Math.random();o.fillCoupons(e)},o.featuredResults(),o.fetchCoupons=function(e){var t="/api/1.0/coupons?max_results=10&sort=-"+e+"&embedded="+JSON.stringify(p)+"&rand="+Math.random();o.fillCoupons(t)},c.getSEO().then(function(o){angular.forEach(o,function(o){"home"===o.selection_type.code&&c.seo("",o,"home")})}),o.banners=[];var f=JSON.stringify({top_banner_string:"home",expired_date:{$gte:(new Date).toGMTString()}});projection={top_banner_string:1,image:1,title:1,image_text:1,destination_url:1},url="/api/1.0/banner?where="+f+"&projection="+JSON.stringify(projection),l.get(url).then(function(e){console.log(e),e.data&&(console.log("Banners: ",e.data._items),o.banners=e.data._items,$("#myCarousel").carousel({interval:4e3,pause:"hover",loop:!0}))},function(o){console.log(o)}),o.openCouponCode=function(e,t){d.destination_url(t.destination_url).then(function(e){o.destionationUrl=e.data.data.output_url,url=i.href("main.home",{cc:t._id,destionationUrl:o.destionationUrl}),console.log("Destination: ",e,o.destionationUrl),$('<a href="'+url+'" target="_blank">&nbsp;</a>')[0].click(),window.location.href=o.destionationUrl},function(o){console.log(o)})};var g={};g.featured_store=!0,projection={},projection.name=1,projection.url=1,projection.image=1,projection.menu=1,projection.related_coupons=1,url="/api/1.0/stores/?where="+JSON.stringify(g)+"&max_results=24&projection="+JSON.stringify(projection),l.get(url).then(function(e){console.log(e),e.data&&(o.stores=e.data._items)},function(o){console.log(o)});var m={};m.featured_category=!0,url="/api/1.0/categories/?where="+JSON.stringify(m)+"&max_results=24&projection="+JSON.stringify(projection),l.get(url).then(function(e){console.log(e),e.data&&(o.categories=e.data._items)},function(o){console.log(o)}),f=JSON.stringify({status:!0}),url="/api/1.0/deals?where="+f+"&max_results=24",l.get(url).then(function(e){console.log(e),e.data&&(o.deals=e.data._items)},function(o){console.log(o)}),a.cc&&($("coupon-info-popup").remove(),p=JSON.stringify({related_stores:1,related_categories:1}),url="/api/1.0/coupons/"+a.cc+"?number_of_clicks=1&embedded="+p+"&rand="+Math.random(),l.get(url).then(function(e){console.log("$stateParams CC Data: ",e.data),o.couponInfo=e.data;var t=u("<coupon-info-popup type='home' coupon='couponInfo'></coupon-info-popup>")(o);$("body").append(t),setTimeout(function(){$("#couponPopup").modal("show")},1e3)},function(o){console.log("$stateParams CC: ",o),i.go("main.home",{cc:void 0,destionationUrl:void 0})})),o.trustAsHtml=function(o){if(o)return e.trustAsHtml(o)},o.showDescription=function(o){$(".show-description").hide(),$("#show-desc-"+o).fadeIn(200)},o.closeDescription=function(){$(".show-description").fadeOut()}}]).factory("Query",["$http","$q",function(o,e){return{get:function(t){var n=e.defer();return o({url:t+"&r="+Math.random(),method:"GET",headers:{"Content-Encoding":"gzip"}}).then(function(o){n.resolve(o)},function(o){n.reject(o)}),n.promise}}}]);